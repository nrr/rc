#! /usr/bin/env bash

# e.g., env KNIFE="nreindlify /opt/junkdrawer/bin/knife" show_vip -r ~/w/git/scm.vgtf.net/vgtf/chef-cartoon 157.166.249.16

PUSHD="__pushd"
POPD="__popd"
KNIFE="${KNIFE-knife}"

is_subshell() {
	if [ "$(basename $1)" = "show_old_vip" ]
	then
		return 0
	fi

	return 255
}

error() {
	echo "$@" >2
}

__pushd() {
	pushd "$@" > /dev/null
}

__popd() {
	popd "$@" > /dev/null
}

show_vip() {
	local repo_path="${CHEF_INFRASTRUCTURE_PATH-}"
	local vip_address=""
	while getopts ":r:" opt
	do
		case $opt in
		r)
			repo_path="$OPTARG"
			;;
		\?)
			error "I don't know what you mean: -$OPTARG"
			exit 111
			;;
		esac
	done

	shift $((OPTIND-1))

	local vips_to_search="$@"

	if [ -z "$repo_path" ]
	then
		error "You can't have a null repo_path."
		exit 10
	fi

	if [ -z "$vips_to_search" ]
	then
		error "You must provide at least one VIP address."
		exit 11
	fi

    $PUSHD $repo_path
    $KNIFE ozone vip list | awk "/$address/ "'{print $1}' | xargs -n 1 $KNIFE ozone vip show --ozone
    $POPD
}

is_subshell "$0" && show_vip "$@"
