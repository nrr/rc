#! /usr/bin/env bash

# e.g., env KNIFE="nreindlify /opt/junkdrawer/bin/knife" show_vip -r ~/w/git/scm.vgtf.net/vgtf/chef-cartoon 157.166.249.16

declare -a DATACENTERS=('56m' 'cop')
PUSHD="__pushd"
POPD="__popd"
KNIFE="${KNIFE-knife}"

is_subshell() {
	if [ "$(basename $1)" = "show_vip" ]
	then
		return 0
	fi

	return -1
}

error() {
	echo "$@" >2
}

__pushd() {
	pushd "$@" > /dev/null
}

__popd() {
	popd "$@" > /dev/null
}

show_vip() {
	local repo_path="${CHEF_INFRASTRUCTURE_PATH-}"
	local vip_address=""
	while getopts ":r:" opt
	do
		case $opt in
		r)
			repo_path="$OPTARG"
			;;
		\?)
			error "I don't know what you mean: -$OPTARG"
			exit 111
			;;
		esac
	done

	shift $((OPTIND-1))

	local vips_to_search="$@"

	if [ -z "$repo_path" ]
	then
		error "You can't have a null repo_path."
		exit 10
	fi

	if [ -z "$vips_to_search" ]
	then
		error "You must provide at least one VIP address."
		exit 11
	fi

    if ! [ -z "$DATACENTERS" ]
    then
        for dc in "${DATACENTERS[@]}"
        do
            $PUSHD "$repo_path/$dc"
            echo Searching in $(basename $(pwd))
            for address in $vips_to_search
            do
                $KNIFE ozone vip list | awk "/$address/ "'{print $1}' | xargs -n 1 $KNIFE ozone vip show --ozone
            done
            $POPD
        done
    else
        $KNIFE ozone vip list | awk "/$address/ "'{print $1}' | xargs -n 1 $KNIFE ozone vip show --ozone
    fi
}

is_subshell "$0" && show_vip "$@"
