#! /usr/bin/env bash
#
# call as: chef-bump-cookbook-version foo 0.9.1 0.9.2 knife node edit foo.atl.corp.yaks.io

# or when dealing with clusters of machines:
#
# cookbook="foo"
# for c in "aa am ay ba bm"
# do
#   pushd $HOME/w/svn/source.corp.yaks.io/chef/$c >/dev/null
#   for h in $(knife search node "recipe:$cookbook" -i | grep yaks.io | sort | uniq)
#   do
#       chef-bump-cookbook-version $cookbook 0.9.1 0.9.2 knife node edit $h
#   done
#   popd >/dev/null
# done

set -u
set -e
set -o pipefail

SED_SCRIPT=$(mktemp)

COOKBOOK_NAME=${1:-}
shift
COOKBOOK_CURRENT_VERSION=${1:-}
shift
COOKBOOK_NEW_VERSION=${1:-}
shift

cat <<EOF >$SED_SCRIPT
/recipe\\[${COOKBOOK_NAME}/ {
	s/${COOKBOOK_CURRENT_VERSION}/${COOKBOOK_NEW_VERSION}/
}
EOF
chmod +x $SED_SCRIPT

exec env EDITOR=$SED_SCRIPT "$@"
