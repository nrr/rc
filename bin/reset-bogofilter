#! /usr/bin/env bash

set -u
set -e
set -o pipefail

TIME_RANGE="$(date +%s -d '30 days ago')..$(date +%s)"

function search_and_run() {
	local search_query="${1:-}"
	local command_to_run="${2:-}"
	notmuch search --output=messages $TIME_RANGE and "${search_query}" | while read id
	do
		echo $id
		notmuch show --format=raw $id | "${command_to_run}"
	done
}

function main() {
	rm -rfv ~/.bogofilter

	search_and_run \
		"not tag:unsure and tag:spam" \
		"bogofilter -s"
	search_and_run \
		"not tag:unsure and not tag:spam" \
		"bogofilter -n"
}

main "$@"
